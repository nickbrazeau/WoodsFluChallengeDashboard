<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woods Lab Influenza Challenge Studies Dashboard</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-brand" style="margin-right: 3rem;">Woods Lab Dashboard</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="studies.html">Studies</a></li>
                <li><a href="data-inventory.html">Data Inventory</a></li>
                <li><a href="samples.html">Sample Inventory</a></li>
                <li><a href="publications.html">Publications</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero">
            <h1>Influenza Challenge Studies Dashboard</h1>
            <p style="font-size: 1.2rem; color: var(--graphite); margin-bottom: 2rem;">
                A comprehensive repository of human influenza challenge study data spanning 20 years of research
            </p>
        </section>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center" style="margin: 3rem 0;">
            <div class="loading"></div>
            <p>Loading dashboard data...</p>
        </div>

        <!-- Statistics Section -->
        <section id="stats-section" class="hidden">
            <h2>Quick Statistics</h2>
            <div class="grid grid-4" id="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="stat-samples">-</span>
                    <span class="stat-label">Total Samples</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-studies">-</span>
                    <span class="stat-label">Challenge Studies</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-participants">-</span>
                    <span class="stat-label">Participants</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-publications">-</span>
                    <span class="stat-label">Publications</span>
                </div>
            </div>

            <div class="grid grid-2 mt-4">
                <div class="stat-card" style="border-left-color: var(--eno);">
                    <span class="stat-number" id="stat-available">-</span>
                    <span class="stat-label">Available Samples</span>
                </div>
                <div class="stat-card" style="border-left-color: var(--persimmon);">
                    <span class="stat-number" id="stat-types">-</span>
                    <span class="stat-label">Sample Types</span>
                </div>
            </div>
        </section>

        <!-- Study Timeline -->
        <section id="timeline-section" class="hidden mt-4">
            <h2>Study Timeline</h2>
            <div class="card">
                <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                    Interactive timeline of human influenza challenge studies from 2008 to 2024. Click on studies for more details.
                </p>
                <div id="timeline-plot" style="width: 100%; height: 400px;"></div>
            </div>
        </section>

        <!-- Statistics Visualizations -->
        <section id="stats-viz-section" class="hidden mt-4">
            <h2>Data Overview</h2>
            <div class="grid grid-2">
                <div class="card">
                    <h3>Samples by Study</h3>
                    <canvas id="study-chart" style="max-height: 350px;"></canvas>
                </div>
                <div class="card">
                    <h3>Sample Types Distribution</h3>
                    <canvas id="types-chart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </section>

        <!-- Quick Links -->
        <section class="mt-4">
            <h2>Explore the Data</h2>
            <div class="grid grid-3">
                <div class="card">
                    <h3>Sample Inventory</h3>
                    <p>Search and filter through 82,000+ biological samples with detailed metadata</p>
                    <a href="samples.html" class="btn mt-2">Browse Samples</a>
                </div>
                <div class="card">
                    <h3>Publications</h3>
                    <p>Explore scientific publications utilizing challenge study data</p>
                    <a href="publications.html" class="btn mt-2">View Publications</a>
                </div>
                <div class="card">
                    <h3>Studies</h3>
                    <p>Learn about each challenge study and available resources</p>
                    <a href="studies.html" class="btn mt-2">View Studies</a>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <p><strong>Woods Lab Influenza Challenge Studies Dashboard</strong></p>
            <p style="font-size: 0.875rem;">Last Updated: <span id="footer-last-updated">Loading...</span></p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                Â© 2025 Woods Lab. Released under the <a href="https://opensource.org/licenses/MIT" target="_blank" style="color: var(--royal-blue); text-decoration: underline;">MIT License</a>.
            </p>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--hatteras);">
                For sample requests or collaboration inquiries, please contact the lab.
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load configuration
                const configResponse = await fetch('data/config.json');
                const config = await configResponse.json();

                // Load statistics
                const statsResponse = await fetch('data/sample_statistics.json');
                const stats = await statsResponse.json();

                // Load publication statistics
                const pubStatsResponse = await fetch('data/publication_statistics.json');
                const pubStats = await pubStatsResponse.json();

                // Update statistics
                document.getElementById('stat-samples').textContent = stats.total_samples.toLocaleString();
                document.getElementById('stat-studies').textContent = stats.total_studies;
                document.getElementById('stat-participants').textContent = stats.total_participants;
                document.getElementById('stat-publications').textContent = pubStats.total_publications;
                document.getElementById('stat-available').textContent = stats.available_samples.toLocaleString();
                document.getElementById('stat-types').textContent = stats.total_sample_types;

                // Update footer last updated
                const lastUpdated = new Date(config.last_updated);
                document.getElementById('footer-last-updated').textContent = lastUpdated.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Display Chart.js visualizations
                displayStudyChart(stats.samples_by_study);
                displaySampleTypesChart(stats.samples_by_type);

                // Display Plotly timeline
                displayInteractiveTimeline();

                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats-section').classList.remove('hidden');
                document.getElementById('timeline-section').classList.remove('hidden');
                document.getElementById('stats-viz-section').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Error loading dashboard data.</strong><br>
                        Please ensure all data files are present in the data/ directory.
                    </div>
                `;
            }
        }

        function displayStudyChart(studyData) {
            const sortedStudies = Object.entries(studyData).sort((a, b) => b[1] - a[1]);
            const labels = sortedStudies.map(([study, _]) => study);
            const data = sortedStudies.map(([_, count]) => count);

            const ctx = document.getElementById('study-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sample Count',
                        data: data,
                        backgroundColor: [
                            '#00539B', '#E89923', '#339898',
                            '#C84E00', '#012169', '#7A0019', '#6F263D'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Samples: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const studyCode = labels[index];
                            window.location.href = `studies.html?study=${studyCode}`;
                        }
                    }
                }
            });
        }

        function displaySampleTypesChart(typeData) {
            const sortedTypes = Object.entries(typeData).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const labels = sortedTypes.map(([type, _]) => type);
            const data = sortedTypes.map(([_, count]) => count);

            const ctx = document.getElementById('types-chart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#00539B', '#E89923', '#339898', '#C84E00',
                            '#012169', '#7A0019', '#6F263D', '#666666'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayInteractiveTimeline() {
            const studies = [
                { code: 'DU08-04', name: 'DEE2', fullName: 'DEE2 H3N2 Flu Challenge', year: 2008, virus: 'H3N2', y: 1 },
                { code: 'DU09-06', name: 'DEE3', fullName: 'DEE3 H1N1 Flu Challenge', year: 2009, virus: 'H1N1', y: 2 },
                { code: 'DU09-07', name: 'DEE4', fullName: 'DEE4 H1N1 Flu Challenge', year: 2009, virus: 'H1N1', y: 1 },
                { code: 'DU11-02', name: 'DEE5', fullName: 'DEE5 H3N2 Flu Challenge', year: 2011, virus: 'H3N2', y: 2 },
                { code: 'DU17-04', name: 'PROMETHEUS', fullName: 'PROMETHEUS H1N1 ICL Flu Challenge', year: 2017, virus: 'H1N1', y: 1 },
                { code: 'DU20-01', name: 'SIGMA Plus', fullName: 'SIGMA Plus H3N2 Flu Challenge', year: 2020, virus: 'H3N2', y: 2 },
                { code: 'DU24-01', name: 'EXHALE', fullName: 'EXHALE H3N2 Flu Challenge', year: 2024, virus: 'H3N2', y: 1 }
            ];

            const h1n1Studies = studies.filter(s => s.virus === 'H1N1');
            const h3n2Studies = studies.filter(s => s.virus === 'H3N2');

            const trace1 = {
                x: h1n1Studies.map(s => s.year),
                y: h1n1Studies.map(s => s.y),
                mode: 'markers+text',
                type: 'scatter',
                name: 'H1N1',
                text: h1n1Studies.map(s => s.name),
                textposition: 'top center',
                marker: {
                    size: 20,
                    color: '#00539B',
                    symbol: 'circle',
                    line: { width: 2, color: '#012169' }
                },
                hovertemplate: '<b>%{text}</b><br>Year: %{x}<br>Click for details<extra></extra>',
                customdata: h1n1Studies.map(s => ({ code: s.code, fullName: s.fullName }))
            };

            const trace2 = {
                x: h3n2Studies.map(s => s.year),
                y: h3n2Studies.map(s => s.y),
                mode: 'markers+text',
                type: 'scatter',
                name: 'H3N2',
                text: h3n2Studies.map(s => s.name),
                textposition: 'bottom center',
                marker: {
                    size: 20,
                    color: '#C84E00',
                    symbol: 'square',
                    line: { width: 2, color: '#7A0019' }
                },
                hovertemplate: '<b>%{text}</b><br>Year: %{x}<br>Click for details<extra></extra>',
                customdata: h3n2Studies.map(s => ({ code: s.code, fullName: s.fullName }))
            };

            const layout = {
                xaxis: {
                    title: 'Year',
                    range: [2007, 2025],
                    dtick: 2,
                    showgrid: true,
                    gridcolor: '#e5e5e5'
                },
                yaxis: {
                    visible: false,
                    range: [0, 3]
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 0.85,
                    y: 0.95,
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                margin: { t: 40, b: 60, l: 50, r: 50 },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
            };

            Plotly.newPlot('timeline-plot', [trace1, trace2], layout, config);

            // Add click event to navigate to study page
            document.getElementById('timeline-plot').on('plotly_click', function(data) {
                const point = data.points[0];
                const studyCode = point.customdata.code;
                window.location.href = `studies.html?study=${studyCode}`;
            });
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
