<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Inventory - Woods Lab Dashboard</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-brand" style="margin-right: 3rem;">Woods Lab Dashboard</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="studies.html">Studies</a></li>
                <li><a href="data-inventory.html">Data Inventory</a></li>
                <li><a href="samples.html">Sample Inventory</a></li>
                <li><a href="publications.html">Publications</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <h1>Data Inventory</h1>
        <p style="font-size: 1.1rem; color: var(--graphite); margin-bottom: 2rem;">
            Comprehensive catalog of molecular data, assays, and data storage locations across all challenge studies
        </p>

        <div class="alert alert-info" style="margin-bottom: 2rem;">
            <strong>Overview:</strong> This page provides a complete overview of all available molecular data,
            assay types, and where the data is currently stored. Use the interactive tables and visualizations to explore
            data provenance and availability.
        </div>

        <!-- Statistics -->
        <div class="grid grid-4" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <span class="stat-number" id="stat-records">-</span>
                <span class="stat-label">Data Records</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-assay-types">-</span>
                <span class="stat-label">Assay Types</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-samples">-</span>
                <span class="stat-label">Samples Analyzed</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-studies">-</span>
                <span class="stat-label">Studies with Data</span>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center" style="margin: 3rem 0;">
            <div class="loading"></div>
            <p>Loading data inventory...</p>
        </div>

        <!-- Pivot Table Controls -->
        <section id="pivot-controls" class="hidden" style="margin-bottom: 2rem;">
            <h2>Interactive Data Table</h2>
            <div class="filters">
                <div class="grid grid-3">
                    <div class="filter-group">
                        <label for="filter-study">Filter by Study</label>
                        <select id="filter-study" onchange="applyFilters()">
                            <option value="">All Studies</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-assay">Filter by Assay Type</label>
                        <select id="filter-assay" onchange="applyFilters()">
                            <option value="">All Assay Types</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-storage">Filter by Storage Location</label>
                        <select id="filter-storage" onchange="applyFilters()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
                    <button class="btn" onclick="exportToCSV()">Export to CSV</button>
                </div>
            </div>
        </section>

        <!-- Data Table -->
        <section id="data-table-section" class="hidden">
            <div class="card">
                <div style="margin-bottom: 1rem;">
                    <strong>Showing <span id="results-count">0</span> records</strong>
                </div>
                <div style="overflow-x: auto;">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Study Name <span class="sort-arrow">↕</span></th>
                                <th onclick="sortTable(1)">Assay Type <span class="sort-arrow">↕</span></th>
                                <th onclick="sortTable(2)">Samples Analyzed <span class="sort-arrow">↕</span></th>
                                <th onclick="sortTable(3)">Subject ID Range <span class="sort-arrow">↕</span></th>
                                <th onclick="sortTable(4)">Timepoints <span class="sort-arrow">↕</span></th>
                                <th onclick="sortTable(5)">Data Storage Location <span class="sort-arrow">↕</span></th>
                            </tr>
                        </thead>
                        <tbody id="data-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Assay Pivot Table by Study -->
        <section id="assay-pivot-section" class="hidden" style="margin-top: 3rem;">
            <h2>Assay Pivot Table by Study</h2>
            <div class="card">
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <strong>Data Availability Note:</strong> Assay tracking records are currently
                    available for the Prometheus (DU17-04) study. Additional studies may be added
                    as assay tracking is completed.
                </div>
                <p style="margin-bottom: 1rem;">Comprehensive matrix showing which assays were performed for each study</p>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="exportAssayPivot()">Export Assay Matrix</button>
                </div>
                <div style="overflow-x: auto;">
                    <div id="assay-pivot-table"></div>
                </div>
            </div>
        </section>

        <!-- Pivot Summary by Study -->
        <section id="pivot-by-study" class="hidden" style="margin-top: 3rem;">
            <h2>Summary by Study</h2>
            <div class="grid grid-2" id="study-summaries"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <p><strong>Woods Lab Influenza Challenge Studies Dashboard</strong></p>
            <p style="font-size: 0.875rem;">Last Updated: <span id="footer-last-updated">Loading...</span></p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                © 2025 Woods Lab. Released under the <a href="https://opensource.org/licenses/MIT" target="_blank" style="color: var(--royal-blue); text-decoration: underline;">MIT License</a>.
            </p>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--hatteras);">
                For sample requests or collaboration inquiries, please contact the lab.
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        let allData = [];
        let filteredData = [];
        let sortColumn = 0;
        let sortAscending = true;

        // Storage location mapping (to be documented)
        const storageLocations = {
            'DU08-04': 'Location pending documentation',
            'DU09-06': 'Location pending documentation',
            'DU09-07': 'Location pending documentation',
            'DU11-02': 'Location pending documentation',
            'DU17-04': 'Location pending documentation',
            'DU20-01': 'Location pending documentation',
            'DU24-01': 'Location pending documentation'
        };

        // Load data
        async function loadData() {
            try {
                const [assaysResponse, studiesResponse, configResponse] = await Promise.all([
                    fetch('data/assays.json'),
                    fetch('data/studies.json'),
                    fetch('data/config.json')
                ]);

                const assays = await assaysResponse.json();
                const studies = await studiesResponse.json();
                const config = await configResponse.json();

                // Update footer
                const lastUpdated = new Date(config.last_updated);
                document.getElementById('footer-last-updated').textContent = lastUpdated.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Enrich assay data with study names and storage locations
                allData = assays.map(assay => {
                    const studyCode = assay.biobank_study_code || 'Unknown';
                    const study = studies[studyCode];
                    return {
                        ...assay,
                        study_name: study ? study.name : assay.Study,
                        storage_location: storageLocations[studyCode] || 'Location pending documentation'
                    };
                });

                filteredData = [...allData];

                // Update statistics
                updateStatistics();

                // Populate filters
                populateFilters();

                // Display data
                displayData();

                // Create study summaries
                createStudySummaries();

                // Create assay pivot table
                createAssayPivotTable();

                // Show sections
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('pivot-controls').classList.remove('hidden');
                document.getElementById('data-table-section').classList.remove('hidden');
                document.getElementById('assay-pivot-section').classList.remove('hidden');
                document.getElementById('pivot-by-study').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Error loading data inventory.</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function updateStatistics() {
            const uniqueStudies = new Set(allData.filter(d => d.biobank_study_code).map(d => d.biobank_study_code)).size;
            const uniqueAssays = new Set(allData.map(d => d.Assay)).size;
            const totalSamples = allData.reduce((sum, d) => sum + (parseInt(d.Samples) || 0), 0);

            document.getElementById('stat-records').textContent = allData.length;
            document.getElementById('stat-assay-types').textContent = uniqueAssays;
            document.getElementById('stat-samples').textContent = totalSamples.toLocaleString();
            document.getElementById('stat-studies').textContent = uniqueStudies;
        }

        function populateFilters() {
            // Study filter
            const studies = getUniqueValues(allData, 'biobank_study_code').filter(s => s && s !== 'Unknown').sort();
            document.getElementById('filter-study').innerHTML += studies.map(s =>
                `<option value="${s}">${s}</option>`
            ).join('');

            // Assay filter
            const assays = getUniqueValues(allData, 'Assay').sort();
            document.getElementById('filter-assay').innerHTML += assays.map(a =>
                `<option value="${a}">${a}</option>`
            ).join('');

            // Storage filter
            const locations = getUniqueValues(allData, 'storage_location').sort();
            document.getElementById('filter-storage').innerHTML += locations.map(l =>
                `<option value="${l}">${l}</option>`
            ).join('');
        }

        function applyFilters() {
            const studyFilter = document.getElementById('filter-study').value;
            const assayFilter = document.getElementById('filter-assay').value;
            const storageFilter = document.getElementById('filter-storage').value;

            filteredData = allData.filter(record => {
                if (studyFilter && record.biobank_study_code !== studyFilter) return false;
                if (assayFilter && record.Assay !== assayFilter) return false;
                if (storageFilter && record.storage_location !== storageFilter) return false;
                return true;
            });

            displayData();
        }

        function resetFilters() {
            document.getElementById('filter-study').value = '';
            document.getElementById('filter-assay').value = '';
            document.getElementById('filter-storage').value = '';
            filteredData = [...allData];
            displayData();
        }

        function displayData() {
            const tbody = document.getElementById('data-tbody');
            const count = filteredData.length;

            document.getElementById('results-count').textContent = count;

            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No records found</td></tr>';
                return;
            }

            let html = '';
            filteredData.forEach(record => {
                html += `
                    <tr>
                        <td>${record.study_name || record.Study}</td>
                        <td><span class="badge badge-primary">${record.Assay}</span></td>
                        <td>${(record.Samples || 0).toLocaleString()}</td>
                        <td>${record['Subject ID ranges'] || 'N/A'}</td>
                        <td style="font-size: 0.875rem;">${record['Timepoint(s)'] || 'N/A'}</td>
                        <td style="font-weight: 500; color: var(--primary-blue);">${record.storage_location}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }

            const columns = ['study_name', 'Assay', 'Samples', 'Subject ID ranges', 'Timepoint(s)', 'storage_location'];
            const col = columns[column];

            filteredData.sort((a, b) => {
                let aVal = a[col] || '';
                let bVal = b[col] || '';

                if (col === 'Samples') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });

            displayData();
        }

        function createStudySummaries() {
            const studySummaries = {};

            allData.forEach(record => {
                const study = record.biobank_study_code || 'Unknown';
                if (!studySummaries[study]) {
                    studySummaries[study] = {
                        study: study,
                        name: record.study_name || record.Study,
                        assays: new Set(),
                        samples: 0,
                        storage: record.storage_location
                    };
                }
                studySummaries[study].assays.add(record.Assay);
                studySummaries[study].samples += parseInt(record.Samples) || 0;
            });

            const container = document.getElementById('study-summaries');
            let html = '';

            Object.values(studySummaries).forEach(summary => {
                if (summary.study === 'Unknown') return;

                html += `
                    <div class="card">
                        <h3 style="margin-bottom: 0.5rem;">${summary.name}</h3>
                        <p style="color: var(--graphite); margin-bottom: 1rem;">
                            <strong>${summary.study}</strong>
                        </p>
                        <div class="grid grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);">
                                    ${summary.assays.size}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--graphite);">Assay Types</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--persimmon);">
                                    ${summary.samples.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--graphite);">Samples Analyzed</div>
                            </div>
                        </div>
                        <div style="padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <div style="font-size: 0.875rem; font-weight: 500; color: var(--graphite); margin-bottom: 0.25rem;">
                                Data Storage:
                            </div>
                            <div style="font-size: 0.875rem; color: var(--primary-blue); font-weight: 500;">
                                ${summary.storage}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function createAssayPivotTable() {
            // Create a pivot table: rows=studies, columns=assays, values=sample counts
            const studies = [...new Set(allData.map(d => d.biobank_study_code).filter(s => s))].sort();
            const assays = [...new Set(allData.map(d => d.Assay).filter(a => a))].sort();

            // Build pivot data
            const pivotData = {};
            studies.forEach(study => {
                pivotData[study] = {};
                assays.forEach(assay => {
                    pivotData[study][assay] = 0;
                });
            });

            // Populate pivot with sample counts
            allData.forEach(record => {
                const study = record.biobank_study_code;
                const assay = record.Assay;
                const samples = parseInt(record.Samples) || 0;

                if (study && assay && pivotData[study] && pivotData[study][assay] !== undefined) {
                    pivotData[study][assay] += samples;
                }
            });

            // Generate HTML table
            const container = document.getElementById('assay-pivot-table');
            let html = '<table style="font-size: 0.9rem;"><thead><tr>';
            html += '<th style="position: sticky; left: 0; background: white; z-index: 10;">Study</th>';
            assays.forEach(assay => {
                html += `<th style="min-width: 80px;">${assay}</th>`;
            });
            html += '<th style="font-weight: bold;">Total</th></tr></thead><tbody>';

            studies.forEach(study => {
                const rowData = pivotData[study];
                const rowTotal = Object.values(rowData).reduce((sum, val) => sum + val, 0);

                html += '<tr>';
                html += `<td style="position: sticky; left: 0; background: white; z-index: 5;"><strong>${study}</strong></td>`;

                assays.forEach(assay => {
                    const count = rowData[assay];
                    const cellStyle = count > 0 ? 'background-color: #e8f4f8;' : '';
                    html += `<td style="text-align: center; ${cellStyle}">${count > 0 ? count.toLocaleString() : '-'}</td>`;
                });

                html += `<td style="font-weight: bold; text-align: center;">${rowTotal.toLocaleString()}</td>`;
                html += '</tr>';
            });

            // Add column totals
            html += '<tr style="border-top: 2px solid #333; font-weight: bold;">';
            html += '<td style="position: sticky; left: 0; background: white; z-index: 5;">Total</td>';

            let grandTotal = 0;
            assays.forEach(assay => {
                const colTotal = studies.reduce((sum, study) => sum + pivotData[study][assay], 0);
                grandTotal += colTotal;
                html += `<td style="text-align: center;">${colTotal.toLocaleString()}</td>`;
            });

            html += `<td style="text-align: center;">${grandTotal.toLocaleString()}</td>`;
            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function exportAssayPivot() {
            const studies = [...new Set(allData.map(d => d.biobank_study_code).filter(s => s))].sort();
            const assays = [...new Set(allData.map(d => d.Assay).filter(a => a))].sort();

            // Build pivot data
            const pivotData = {};
            studies.forEach(study => {
                pivotData[study] = {};
                assays.forEach(assay => {
                    pivotData[study][assay] = 0;
                });
            });

            allData.forEach(record => {
                const study = record.biobank_study_code;
                const assay = record.Assay;
                const samples = parseInt(record.Samples) || 0;

                if (study && assay && pivotData[study]) {
                    pivotData[study][assay] += samples;
                }
            });

            // Generate CSV
            let csv = 'Study,' + assays.join(',') + ',Total\n';

            studies.forEach(study => {
                const rowData = pivotData[study];
                const rowTotal = Object.values(rowData).reduce((sum, val) => sum + val, 0);
                const row = [study, ...assays.map(a => rowData[a] || 0), rowTotal];
                csv += row.join(',') + '\n';
            });

            // Add totals row
            const totals = ['Total'];
            let grandTotal = 0;
            assays.forEach(assay => {
                const colTotal = studies.reduce((sum, study) => sum + pivotData[study][assay], 0);
                grandTotal += colTotal;
                totals.push(colTotal);
            });
            totals.push(grandTotal);
            csv += totals.join(',') + '\n';

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'assay_pivot_by_study.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            const headers = ['Study Name', 'Assay Type', 'Samples', 'Subject ID Range', 'Timepoints', 'Storage Location'];
            const rows = filteredData.map(record => [
                record.study_name || record.Study || '',
                record.Assay || '',
                record.Samples || '0',
                record['Subject ID ranges'] || '',
                record['Timepoint(s)'] || '',
                record.storage_location || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data_inventory.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Load on page load with access control
        document.addEventListener('DOMContentLoaded', () => {
            // Check access level before loading data
            const accessLevel = getAccessLevel(); // from main.js

            if (accessLevel === 'public') {
                // Hide all content sections
                const sectionsToHide = [
                    'pivot-controls',
                    'data-table-section',
                    'assay-pivot-section',
                    'pivot-by-study'
                ];

                sectionsToHide.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'none';
                });

                // Hide statistics cards (they don't have a section wrapper)
                const statsGrid = document.querySelector('.grid.grid-4');
                if (statsGrid) statsGrid.style.display = 'none';

                // Show authentication required message
                const main = document.querySelector('main');
                const notice = document.createElement('div');
                notice.className = 'card';
                notice.style.margin = '2rem auto';
                notice.style.maxWidth = '600px';
                notice.innerHTML = `
                    <div class="alert alert-info">
                        <h2 style="margin-top: 0;">Authentication Required</h2>
                        <p style="margin-top: 1rem;">
                            The Data Inventory page is only available in private mode.
                            This page contains detailed assay tracking information and data storage locations
                            that require authentication to access.
                        </p>
                        <p style="margin-top: 1rem;">
                            <strong>For access:</strong> Please contact the lab administrator.
                        </p>
                    </div>
                `;
                main.insertBefore(notice, main.firstChild);

                // Don't load data
                return;
            }

            // Private mode: load data normally
            loadData();
            initializeSortableTable();
        });
    </script>
</body>
</html>
