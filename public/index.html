<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woods Lab Influenza Challenge Studies Dashboard</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-brand">Woods Lab Dashboard</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="studies.html">Studies</a></li>
                <li><a href="data-inventory.html">Data Inventory</a></li>
                <li><a href="samples.html">Sample Inventory</a></li>
                <li><a href="publications.html">Publications</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero">
            <h1>Influenza Challenge Studies Dashboard</h1>
            <p style="font-size: 1.2rem; color: var(--graphite); margin-bottom: 2rem;">
                A comprehensive repository of human influenza challenge study data spanning 20 years of research
            </p>
        </section>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center" style="margin: 3rem 0;">
            <div class="loading"></div>
            <p>Loading dashboard data...</p>
        </div>

        <!-- Statistics Section -->
        <section id="stats-section" class="hidden">
            <h2>Quick Statistics</h2>
            <div class="grid grid-4" id="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="stat-samples">-</span>
                    <span class="stat-label">Total Samples</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-studies">-</span>
                    <span class="stat-label">Challenge Studies</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-participants">-</span>
                    <span class="stat-label">Participants</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-publications">-</span>
                    <span class="stat-label">Publications</span>
                </div>
            </div>

            <div class="grid grid-2 mt-4">
                <div class="stat-card" style="border-left-color: var(--eno);">
                    <span class="stat-number" id="stat-available">-</span>
                    <span class="stat-label">Available Samples</span>
                </div>
                <div class="stat-card" style="border-left-color: var(--persimmon);">
                    <span class="stat-number" id="stat-types">-</span>
                    <span class="stat-label">Sample Types</span>
                </div>
            </div>
        </section>

        <!-- Study Timeline -->
        <section id="timeline-section" class="hidden mt-4">
            <h2>Study Timeline</h2>
            <div class="card">
                <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                    Research spanning from 2008 to 2024, encompassing multiple influenza challenge studies
                </p>
                <div id="timeline-content"></div>
            </div>
        </section>

        <!-- Samples by Study -->
        <section id="study-breakdown-section" class="hidden mt-4">
            <h2>Samples by Study</h2>
            <div class="card">
                <div id="study-breakdown"></div>
            </div>
        </section>

        <!-- Sample Types Distribution -->
        <section id="sample-types-section" class="hidden mt-4">
            <h2>Top Sample Types</h2>
            <div class="card">
                <div id="sample-types"></div>
            </div>
        </section>

        <!-- Quick Links -->
        <section class="mt-4">
            <h2>Explore the Data</h2>
            <div class="grid grid-3">
                <div class="card">
                    <h3>Sample Inventory</h3>
                    <p>Search and filter through 82,000+ biological samples with detailed metadata</p>
                    <a href="samples.html" class="btn mt-2">Browse Samples</a>
                </div>
                <div class="card">
                    <h3>Publications</h3>
                    <p>Explore scientific publications utilizing challenge study data</p>
                    <a href="publications.html" class="btn mt-2">View Publications</a>
                </div>
                <div class="card">
                    <h3>Studies</h3>
                    <p>Learn about each challenge study and available resources</p>
                    <a href="studies.html" class="btn mt-2">View Studies</a>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <p><strong>Woods Lab Influenza Challenge Studies Dashboard</strong></p>
            <p style="font-size: 0.875rem;">Last Updated: <span id="footer-last-updated">Loading...</span></p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                Â© 2025 Woods Lab. Released under the <a href="https://opensource.org/licenses/MIT" target="_blank" style="color: var(--royal-blue); text-decoration: underline;">MIT License</a>.
            </p>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--hatteras);">
                For sample requests or collaboration inquiries, please contact the lab.
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load configuration
                const configResponse = await fetch('data/config.json');
                const config = await configResponse.json();

                // Load statistics
                const statsResponse = await fetch('data/sample_statistics.json');
                const stats = await statsResponse.json();

                // Load publication statistics
                const pubStatsResponse = await fetch('data/publication_statistics.json');
                const pubStats = await pubStatsResponse.json();

                // Update statistics
                document.getElementById('stat-samples').textContent = stats.total_samples.toLocaleString();
                document.getElementById('stat-studies').textContent = stats.total_studies;
                document.getElementById('stat-participants').textContent = stats.total_participants;
                document.getElementById('stat-publications').textContent = pubStats.total_publications;
                document.getElementById('stat-available').textContent = stats.available_samples.toLocaleString();
                document.getElementById('stat-types').textContent = stats.total_sample_types;

                // Update footer last updated
                const lastUpdated = new Date(config.last_updated);
                document.getElementById('footer-last-updated').textContent = lastUpdated.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Display study breakdown
                displayStudyBreakdown(stats.samples_by_study);

                // Display sample types
                displaySampleTypes(stats.samples_by_type);

                // Display timeline
                displayTimeline(config);

                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats-section').classList.remove('hidden');
                document.getElementById('timeline-section').classList.remove('hidden');
                document.getElementById('study-breakdown-section').classList.remove('hidden');
                document.getElementById('sample-types-section').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Error loading dashboard data.</strong><br>
                        Please ensure all data files are present in the data/ directory.
                    </div>
                `;
            }
        }

        function displayStudyBreakdown(studyData) {
            const container = document.getElementById('study-breakdown');
            const sortedStudies = Object.entries(studyData).sort((a, b) => b[1] - a[1]);

            let html = '<table><thead><tr><th>Study Code</th><th>Sample Count</th><th>Percentage</th></tr></thead><tbody>';

            const total = Object.values(studyData).reduce((sum, count) => sum + count, 0);

            sortedStudies.forEach(([study, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                html += `
                    <tr>
                        <td><strong>${study}</strong></td>
                        <td>${count.toLocaleString()}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displaySampleTypes(typeData) {
            const container = document.getElementById('sample-types');
            const sortedTypes = Object.entries(typeData).sort((a, b) => b[1] - a[1]);

            let html = '<table><thead><tr><th>Sample Type</th><th>Count</th></tr></thead><tbody>';

            sortedTypes.forEach(([type, count]) => {
                html += `
                    <tr>
                        <td><strong>${type}</strong></td>
                        <td>${count.toLocaleString()}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayTimeline(config) {
            const container = document.getElementById('timeline-content');
            const studies = [
                { code: 'DU08-04', name: 'DEE2 H3N2', year: 2008, virus: 'H3N2' },
                { code: 'DU09-06', name: 'DEE3 H1N1', year: 2009, virus: 'H1N1' },
                { code: 'DU09-07', name: 'DEE4 H1N1', year: 2009, virus: 'H1N1' },
                { code: 'DU11-02', name: 'DEE5 H3N2', year: 2011, virus: 'H3N2' },
                { code: 'DU17-04', name: 'PROMETHEUS', year: 2017, virus: 'H1N1' },
                { code: 'DU20-01', name: 'SIGMA Plus', year: 2020, virus: 'H3N2' },
                { code: 'DU24-01', name: 'EXHALE', year: 2024, virus: 'H3N2' }
            ];

            let html = '<div style="overflow-x: auto;">';
            html += '<table><thead><tr><th>Year</th><th>Study Code</th><th>Name</th><th>Virus</th></tr></thead><tbody>';

            studies.forEach(study => {
                html += `
                    <tr>
                        <td><strong>${study.year}</strong></td>
                        <td><span class="badge badge-primary">${study.code}</span></td>
                        <td>${study.name}</td>
                        <td>${study.virus}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
